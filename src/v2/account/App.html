<div class="admin">
    <h1 class="title">{__('account / settings')}</h1>
    {#each invitations as team}
    <div class="alert alert-info">
        You have been invited to join the team <b>{truncate(team.name, 20, 10)}</b>. Click here to
        <a href="/organization-invite/{team.token}" class="btn btn-primary">accept the invitation</a>
    </div>
    {/each}
    <NavTabs basePath="account" ref:navTabs groups="{groups}" bind:activeTab />
</div>
<script>
    /* globals dw */
    import { __ } from '@datawrapper/shared/l10n';
    import truncate from '@datawrapper/shared/truncate';
    import EditProfile from './EditProfile.html';
    import NavTabs from '../shared/NavTabs.html';
    import MyTeams from './MyTeams.html';

    const EditProfileTab = {
        title: __('account / profile'),
        id: 'profile',
        icon: 'im im-user-settings',
        ui: EditProfile,
        data: {}
    };

    const MyTeamsTab = {
        title: __('account / my-teams'),
        id: 'teams',
        icon: 'im im-users',
        ui: MyTeams,
        data: {}
    };

    export default {
        components: { NavTabs },
        data() {
            return {
                hash: 'profile',
                activeTab: null,
                activeData: {},
                groups: [
                    {
                        title: __('account / settings / personal'),
                        tabs: [EditProfileTab]
                    }
                ]
            };
        },
        computed: {
            data({ email, user, userId, teams, currentTeam }) {
                return { user, email, userId, teams, currentTeam };
            }
        },
        helpers: {
            __,
            truncate
        },
        methods: {},
        oncreate() {
            const path = window.location.pathname.split('/').slice(1);
            const initialTab = path[1] || 'profile';

            dw.backend.__svelteApps.account = this;

            const { email, user, userId, groups, teams, adminTeams, pages, currentTeam } = this.get();

            if (pages.length) {
                groups[0].tabs.push.apply(groups[0].tabs, pages);
                this.set({ groups });
            }

            groups[0].tabs.splice(1, 0, MyTeamsTab);
            this.set({ groups });

            if (adminTeams.length) {
                groups.push({
                    title: __('account / settings / team'),
                    tabs: []
                });
                adminTeams.forEach(({ Id, Name }) => {
                    groups[1].tabs.push({
                        title: truncate(Name, 10, 4),
                        url: `/team/${Id}/settings`,
                        icon: 'im im-users'
                    });
                });
                this.set({ groups });
            }

            EditProfileTab.data = { email, userId, user };
            MyTeamsTab.data = { teams, currentTeam, user };

            let foundTab = false;
            groups.forEach(group => {
                group.tabs.forEach(tab => {
                    if (tab.id === initialTab) {
                        this.refs.navTabs.activateTab(tab);
                        foundTab = true;
                    }
                });
            });
            if (!foundTab) {
                this.set({
                    activeTab: EditProfileTab
                });
            }
        },
        onstate({ changed, current }) {
            if (changed.activeTab && current.activeTab) {
                window.history.pushState({ id: current.activeTab.id }, '', `/account/${current.activeTab.id}`);
            }
        }
    };
</script>

<style type="text/css" lang="less">
    .settings-section {
        padding-top: 10px;
        margin-top: 10px;

        .base-dropdown-content {
            top: 30px !important;
        }
    }

    .admin {
        :global(h2) {
            font-size: 26px;
            border-bottom: 1px solid #eee;
            margin-bottom: 1em;
            padding-bottom: 1ex;
        }

        :global(h3) {
            font-size: 22px;
        }

        :global(p.help) {
            font-size: 16px;
            color: #888;
            line-height: 1.5;
        }
    }
</style>
