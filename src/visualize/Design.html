<HookBlocks key="design-blocks" />

{#if groups.layout.length }
<Group label="Layout options">
    <DesignBlocks bind:blocks="groups.layout" />
</Group>
{/if} {#if groups.download.length }
<Group label="Download options">
    <DesignBlocks bind:blocks="groups.download" />
</Group>
{/if} {#if groups.sharing.length }
<Group label="Sharing options">
    <DesignBlocks bind:blocks="groups.sharing" />
</Group>
{/if}

<script>
    /* globals dw */
    import { __ } from '@datawrapper/shared/l10n';
    import { Group } from '@datawrapper/controls';
    import get from '@datawrapper/shared/get';
    import arrayToObject from '@datawrapper/shared/arrayToObject';
    import HookBlocks from './HookBlocks.html';
    import DesignBlocks from './DesignBlocks.html';
    import GetTheData from './design-blocks/GetTheData.html';
    import Embed from './design-blocks/Embed.html';
    import LayoutSelect from './design-blocks/LayoutSelect.html';
    import Logo from './design-blocks/Logo.html';

    function getBlocks(allBlocks, group, props) {
        return allBlocks
            .filter(d => d.group === group)
            .filter(d => (d.visible !== undefined ? d.visible : true))
            .sort(byPriority);
    }
    function byPriority(a, b) {
        return (
            (a.priority !== undefined ? a.priority : 999) -
            (b.priority !== undefined ? b.priority : 999)
        );
    }

    export default {
        components: {
            Group,
            HookBlocks,
            DesignBlocks
        },
        data() {
            return {
                allBlocks: [],
                hookBlocks: []
            };
        },
        computed: {
            groups({ $organizationId, $teamSettings, allBlocks }) {
                return {
                    download: getBlocks(allBlocks, 'download'),
                    layout: getBlocks(allBlocks, 'layout'),
                    sharing: getBlocks(allBlocks, 'sharing')
                };
            },
            coreBlocks({ $organizationId, $teamSettings, themeHasLogo, $theme }) {
                const flags = $teamSettings.flags;
                return [
                    {
                        ui: Embed,
                        label: 'Enable embed',
                        visible: flags.embed || !$organizationId,
                        group: 'sharing',
                        priority: 1
                    },
                    {
                        ui: GetTheData,
                        label: 'Enable data download',
                        visible: flags.get_the_data || !$organizationId,
                        group: 'download',
                        priority: 1
                    },
                    {
                        ui: Logo,
                        label: 'Logo',
                        visible: themeHasLogo,
                        group: 'layout',
                        priority: 1
                    },
                    {
                        ui: LayoutSelect,
                        visible: flags.layout_selector || !$organizationId,
                        group: 'layout',
                        priority: 0
                    }
                ];
            },
            themeHasLogo({ $themeData }) {
                return (
                    get($themeData, 'options.footer.logo.url') ||
                    get($themeData, 'options.footer.logo.text')
                );
            }
        },
        helpers: { __ },
        oncreate() {
            const chart = this.store;
            let options = this.store.getMetadata('publish.options', {});
            options = arrayToObject(options);
            this.store.setMetadata('publish.options', options);
            const { results } = dw.backend.hooks.call(`design-blocks-grouped`, [chart]);
            this.set({ hookBlocks: results });
        },
        onstate({ previous, current, changed }) {
            if (previous) {
                const allBlocks = [...current.hookBlocks, ...(current.coreBlocks || [])];
                this.set({ allBlocks });
            }
        }
    };
</script>
