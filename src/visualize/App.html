<div class="dw-create-visualize chart-editor">
    <div class="vis-wrapper" ref:wrapper>
        <div
            class="vis-main"
            ref:canvas
            class:stickyBottom="stickyBottom"
            class:stickyTop="stickyTop"
        >
            <div class="container">
                <div class="vis-canvas">
                    <ChartPreview src="/preview/{ $id }" on:resize="makePreviewSticky()" />

                    <div class="toolbar">
                        <Resizer />
                        <ColorblindCheck />
                    </div>

                    <div id="notifications"></div>
                </div>
            </div>
        </div>

        <div class="visconfig vis-sidebar" ref:sidebar>
            <TabNav bind:tab {showChartPicker} />
            <div class="form-horizontal vis-options">
                {#if showChartPicker}
                <!-- Chart Type -->
                <div class:hide-smart="tab !== 'pick'">
                    <ChartPicker
                        {visualizations}
                        {visArchive}
                        {namespace}
                        on:change="loadVis(event)"
                    />
                </div>
                {/if}

                <!-- Refine -->
                <div class:hide-smart="tab !== 'refine'">
                    {#if visLoading}
                    <Loading />
                    {:else}
                    <svelte:component this="{Refine}" {tab} />
                    {/if}
                </div>

                <!-- Annotate -->
                <div class:hide-smart="tab !== 'annotate'">
                    <Annotate />
                    {#if visLoading}
                    <Loading />
                    {:else}
                    <svelte:component this="{Annotate}" {tab} />
                    {/if}
                </div>

                <!-- Design -->
                <div class:hide-smart="tab !== 'design'">
                    <Design />
                </div>

                <ButtonNav bind:tab {showChartPicker} />
            </div>
        </div>
    </div>
</div>

<style>
    @media (min-width: 980px) {
        .vis-wrapper {
            position: relative;
        }

        .vis-main {
            position: relative;
            top: 0;
            padding: 15px;
        }

        .vis-main.stickyBottom {
            position: absolute;
            top: auto;
            bottom: 0;
        }

        .vis-main.stickyTop {
            position: fixed;
            top: 0;
            bottom: auto;
        }

        .vis-main {
            position: absolute;
        }

        .vis-sidebar {
            width: 33%;
        }

        .vis-canvas {
            padding-left: 33%;
        }
    }
</style>

<script>
    /* globals dw */
    import { loadScript, loadStylesheet } from '@datawrapper/shared/fetch';
    import ChartPreview from '@datawrapper/controls/editor/ChartPreview.html';
    import TabNav from './TabNav.html';
    import ButtonNav from './ButtonNav.html';
    import Empty from './Empty.html';
    import Annotate from './Annotate.html';
    import Design from './Design.html';
    import ChartPicker from './ChartPicker.html';
    import Loading from './Loading.html';
    import Resizer from './Resizer.html';
    import ColorblindCheck from './colorblind-check/ColorblindCheck.html';

    export default {
        components: {
            TabNav,
            ButtonNav,
            Annotate,
            Design,
            ChartPicker,
            Loading,
            Resizer,
            ColorblindCheck,
            ChartPreview
        },
        data() {
            return {
                tab: 'refine',
                Refine: Empty,
                Annotate: Empty,
                visualizations: [],
                visArchive: [],
                visLoading: false,
                defaultVisType: '',
                stickyTop: false,
                stickyBottom: false,
                namespace: 'chart'
            };
        },
        computed: {
            showChartPicker({ namespace }) {
                return namespace !== 'map';
            }
        },
        methods: {
            makePreviewSticky() {
                const { top, bottom } = this.refs.wrapper.getBoundingClientRect();
                const canvasHeight = this.refs.canvas.scrollHeight;
                const sidebarHeight = this.refs.sidebar.scrollHeight;
                const useSticky = canvasHeight < sidebarHeight;
                this.set({
                    stickyTop: useSticky && top < 0 && bottom >= canvasHeight,
                    stickyBottom: useSticky && bottom < canvasHeight
                });
            },
            loadVis(type) {
                this.set({ visLoading: true });
                this.store.set({ type });
                this.loadControls(type);
            },
            loadControls(type) {
                const chart = this.store;
                const { visArchive, visualizations } = this.get();
                const vis = [...visArchive, ...visualizations].find(v => v.id === type);

                if (!vis.controls) {
                    console.error('This visualization does not define new svelte controls');
                    return;
                }

                Promise.all([
                    loadScript(`/static/plugins/${vis.controls.js}`),
                    loadScript(
                        `${window.location.protocol}//${window.dw.backend.__api_domain}/v3/visualizations/${vis.id}/script.js`
                    ),
                    loadStylesheet(`/static/plugins/${vis.controls.css}`)
                ]).then(() => {
                    require([vis.controls.amd], mod => {
                        // initialize with empty Refine and Annotate panel
                        this.set({ Refine: Empty, Annotate: Empty });

                        // make sure all core metadata properties are set before loading controls
                        ['annotate', 'axes', 'data', 'describe', 'publish', 'visualize'].forEach(
                            key => {
                                if (chart.getMetadata(key) === undefined) {
                                    chart.setMetadata(key, {});
                                }
                            }
                        );

                        if (mod.migrate) {
                            const { metadata } = chart.get();
                            mod.migrate(type, metadata, chart.dataset());
                            chart.set({ metadata });
                        }

                        // apply vis default metadata
                        const visualize = {
                            ...(vis.controls.defaults || {}),
                            ...chart.getMetadata('visualize', {})
                        };
                        chart.setMetadata('visualize', visualize);
                        chart.set({ visualization: vis });

                        // determine if we automaticall switch to refine tab
                        // const { tab, defaultVisType } = this.get();
                        // const chartTypeSet =
                        //     chart.getMetadata('visualize.chart-type-set', false) ||
                        //     id !== defaultVisType;

                        // this.set({
                        //     tab: tab === 'pick' && chartTypeSet ? 'refine' : tab
                        // });

                        const vis2 = dw.visualization(vis.id);
                        vis2.meta = vis;
                        vis2.lang = chart.get().language.substr(0, 2);

                        vis2.chart(chart);
                        chart.vis(vis2);

                        this.set({
                            visLoading: false,
                            Refine: mod.Refine || Empty,
                            Annotate: mod.Annotate || Empty
                        });

                        // dw.backend.fire('options-reloaded');
                    });
                });
            }
        },
        oncreate() {
            // update tab navigation based on URL hash:
            if (['#pick', '#refine', '#annotate', '#design'].includes(window.location.hash)) {
                this.set({ tab: window.location.hash.substr(1) });
            }

            // load visualization:
            const { type } = this.store.get();
            this.loadVis(type);

            // add event handler for making the preview stick to the viewport:
            const makePreviewSticky = () => this.makePreviewSticky();
            window.addEventListener('scroll', makePreviewSticky);

            // remove event handler when this component is destroyed:
            this.on('destroy', () => {
                window.removeEventListener('scroll', makePreviewSticky);
            });
        }
    };
</script>
