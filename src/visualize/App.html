<TabNav bind:tab {showChartPicker} />

<div class="form-horizontal vis-options">
    {#if showChartPicker}
    <!-- Chart Type -->
    <div class:hide-smart="tab !== 'pick'">
        <ChartPicker {visualizations} {visArchive} on:change="loadVis(event)" />
    </div>
    {/if}

    <!-- Refine -->
    <div class:hide-smart="tab !== 'refine'">
        {#if visLoading}
        <Loading />
        {/if}
        <svelte:component this="{Refine}" {tab} />
    </div>

    <!-- Annotate -->
    <div class:hide-smart="tab !== 'annotate'">
        <ChartDescription />
        {#if visLoading}
        <Loading />
        {/if}
        <svelte:component this="{Annotate}" {tab} />
    </div>

    <!-- Design -->
    <div class:hide-smart="tab !== 'design'">
        <Design />
    </div>

    <ButtonNav bind:tab {showChartPicker} />
</div>

<script>
    /* globals dw, $  */
    import TabNav from './TabNav.html';
    import ButtonNav from './ButtonNav.html';
    import Empty from './Empty.html';
    import Design from './Design.html';
    import ChartPicker from './ChartPicker.html';
    import Loading from './Loading.html';
    import ChartDescription from '@datawrapper/controls/editor/ChartDescription.html';
    import { loadScript, loadStylesheet } from '@datawrapper/shared/fetch';

    export default {
        components: {
            TabNav,
            ButtonNav,
            Design,
            ChartPicker,
            Loading,
            ChartDescription
        },
        data() {
            return {
                tab: 'refine',
                showChartPicker: true,
                Refine: Empty,
                Annotate: Empty,
                visualizations: [],
                visArchvive: [],
                visLoading: false,
                defaultVisType: ''
            };
        },
        methods: {
            loadVis(id) {
                const { visualizations } = this.get();
                const chart = this.store;
                const vis = visualizations.find(v => v.id === id);
                this.set({ visLoading: true });
                if (!vis.controls) {
                    console.error('This visualization does not define new svelte controls');
                    return;
                }
                const { type } = chart.get();
                if (type !== id) {
                    chart.setMetadata('visualize.chart-type-set', true);
                    chart.set({
                        type: id
                    });
                }
                Promise.all([
                    loadScript(`/static/plugins/${vis.controls.js}`),
                    loadStylesheet(`/static/plugins/${vis.controls.css}`)
                ]).then(() => {
                    /* crazy workaround:
                     * since only the first requirejs call will fail with an
                     * a Mismatched anonymous define() modules error
                     * we'll just load the module twice
                     */
                    try {
                        require([vis.controls.amd], mod => {});
                    } catch (e) {}
                    require([vis.controls.amd], mod => {
                        this.set({
                            Refine: Empty,
                            Annotate: Empty
                        });
                        if (mod.migrate) {
                            const { metadata } = chart.get();
                            mod.migrate(id, metadata);
                            chart.set({ metadata });
                        }

                        // apply vis default metadata
                        const visualize = {
                            ...(vis.controls.defaults || {}),
                            ...chart.getMetadata('visualize', {})
                        };
                        chart.setMetadata('visualize', visualize);
                        chart.set({
                            visualization: vis
                        });
                        // determine if we automaticall switch to refine tab
                        const { tab, defaultVisType } = this.get();
                        const chartTypeSet =
                            chart.getMetadata('visualize.chart-type-set', false) ||
                            id !== defaultVisType;

                        this.set({
                            tab: tab === 'pick' && chartTypeSet ? 'refine' : tab
                        });

                        dw.backend.once('vis-ready', () => {
                            // wait for chart preview
                            getContext(win => {
                                // set refine & annotate controls and switch tab
                                chart.set({ vis: win.__dw.vis });
                                this.set({
                                    visLoading: false,
                                    Refine: mod.Refine || Empty,
                                    Annotate: mod.Annotate || Empty
                                });
                                dw.backend.fire('options-reloaded');
                            });
                        });
                    });
                });
            }
        },
        oncreate() {
            if (['#pick', '#refine', '#annotate', '#design'].includes(window.location.hash)) {
                this.set({ tab: window.location.hash.substr(1) });
            }
            // load visualization
            const { type } = this.store.get();
            this.loadVis(type);
        }
    };

    function getContext(callback) {
        var win = $('#iframe-vis').get(0).contentWindow;
        var doc = $('#iframe-vis').get(0).contentDocument;
        if (!win || !win.__dw || !win.__dw.vis) {
            return setTimeout(function () {
                getContext(callback);
            }, 200);
        }
        callback(win, doc);
    }
</script>
