<div style="margin-top: 30px;" class="{published?'':'inactive'}">
    <h2>{@html __('publish / share-embed') }</h2>
    <div class="block">
        <i class="icon fa fa-link fa-fw"></i>
        <div class="ctrls">
            <div class="h">
                <b>{@html __('publish / share-url') }</b>
                <div class="embed-options">
                    <label class="radio">
                        <input
                            bind:group="shareurl_type"
                            value="default"
                            type="radio"
                            name="url-type"
                        />
                        {@html __('publish / share-url / fullscreen') }
                    </label>
                    {#each plugin_shareurls as tpl}
                    <label class="radio"
                        ><input
                            bind:group="shareurl_type"
                            value="{tpl.id}"
                            type="radio"
                            name="url-type"
                        />
                        {@html tpl.name}</label
                    >
                    {/each}
                </div>
            </div>
            <div class="inpt">
                <a target="_blank" class="share-url" href="{shareUrl}">{shareUrl}</a>
            </div>
        </div>
        <HelpDisplay>
            <div>{@html __('publish / help / share-url') }</div>
        </HelpDisplay>
    </div>

    <div class="block">
        <i class="icon fa fa-code fa-fw"></i>
        <div class="ctrls">
            <div class="h">
                <b>{@html __('publish / embed') }</b>
                <div class="embed-options">
                    {#each embed_templates as tpl}
                    <label class="radio"
                        ><input type="radio" bind:group="embed_type" value="{tpl.id}" /> { tpl.title
                        }</label
                    >
                    {/each}
                </div>
            </div>
            <div class="inpt">
                <textarea
                    ref:embedInput
                    type="text"
                    class="input embed-code"
                    readonly
                    value="{embedCode}"
                ></textarea>
                <button class="btn btn-copy" on:click="copy(embedCode)" title="copy">
                    <i class="fa fa-copy"></i> { __('publish / copy') }
                </button>
                <div class="copy-success {copy_success ? 'show':''}">
                    { __('publish / copy-success') }
                </div>
            </div>
        </div>
        <HelpDisplay>
            <div>
                {@html __('publish / embed / help') } {#each embed_templates.slice(2) as tpl}
                <div><b>{tpl.title}:</b> {@html purifyHtml(tpl.text) }</div>
                {/each}
            </div>
        </HelpDisplay>
    </div>
</div>

<style>
    input[type='radio'] {
        vertical-align: baseline !important;
        margin-left: -20px !important;
    }
    a.share-url {
        font-size: 18px;
    }
    .copy-success {
        font-size: 11px;
        color: #9c9;
        font-style: italic;
        opacity: 0;
        pointer-events: none;
        transition: opacity 5s ease-in;
        margin-top: -10px;
        position: absolute;
    }
    .copy-success.show {
        opacity: 1;
        transition: none;
    }
    .embed-options {
        display: inline-block;
    }
    .embed-code {
        height: 20px;
    }
</style>

<script>
    import HelpDisplay from '@datawrapper/controls/HelpDisplay.html';
    import purifyHtml from '@datawrapper/shared/purifyHtml';
    import { __ } from '@datawrapper/shared/l10n';
    import { trackEvent } from '@datawrapper/shared/analytics';
    import get from '@datawrapper/shared/get';

    export default {
        components: {
            HelpDisplay
        },
        data() {
            return {
                embed_templates: [],
                plugin_shareurls: [],
                published: false,
                shareurl_type: 'default',
                embed_type: 'responsive',
                copy_success: false,
                embedCode: ''
            };
        },
        computed: {
            shareUrl({ shareurl_type, $id, $publicUrl, $metadata, plugin_shareurls, published }) {
                if (!published) return 'https://www.datawrapper.de/...';
                if (shareurl_type === 'default') return $publicUrl;
                let url = '';

                plugin_shareurls.forEach(t => {
                    if (t.id === shareurl_type) {
                        url = t.url.replace(/%chart_id%/g, $id);

                        url = url.replace(/%(.*?)%/g, (match, path) => {
                            return get(
                                {
                                    id: $id,
                                    metadata: $metadata
                                },
                                path
                            );
                        });
                    }
                });
                return url;
            }
        },
        helpers: {
            __,
            purifyHtml
        },
        methods: {
            setEmbedCode() {
                const chart = this.store;
                const state = this.get();
                if (!state) return;
                const embedType = state.embed_type ? `embed-method-${state.embed_type}` : null;

                const { publicUrl } = chart.get();
                const embedCodes = chart.getMetadata('publish.embed-codes');
                const embedHeight = chart.getMetadata('publish.embed-height');

                this.set({
                    embedCode:
                        embedCodes && embedCodes[embedType]
                            ? embedCodes[embedType]
                            : embedType === 'custom'
                            ? ''
                            : `<iframe src="${publicUrl}" width="100%" height="${embedHeight}" scrolling="no" frameborder="0" allowtransparency="true"></iframe>`
                });
            },

            copy() {
                const me = this;
                me.refs.embedInput.select();
                try {
                    var successful = document.execCommand('copy');
                    if (successful) {
                        trackEvent('Chart Editor', 'embedcode-copy');
                        me.set({ copy_success: true });
                        setTimeout(() => me.set({ copy_success: false }), 300);
                    }
                } catch (err) {
                    // console.log('Oops, unable to copy');
                }
            }
        },

        oncreate() {
            // watch changes
            this.setEmbedCode();
            const chart = this.store;
            chart.observeDeep('metadata.publish.embed-codes', () => this.setEmbedCode());
            chart.observeDeep('metadata.publish.embed-height', () => this.setEmbedCode());
            chart.observeDeep('publicUrl', () => this.setEmbedCode());
        }
    };
</script>
