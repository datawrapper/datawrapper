<div style="margin-top: 30px;" class="{published?'':'inactive'}">
    <h2>{@html __('publish / share-embed') }</h2>
    <div class="block">
        <div class="h">
            <b>{@html __('publish / share-url') }</b>
        </div>
        <div class="inpt">
            <a target="_blank" class="share-url" href="{shareUrl}">{shareUrl}</a>
        </div>

        <RadioControl options="{shareOptions}" bind:value="shareurlType" label="" />
        <HelpDisplay>
            <div>{@html __('publish / help / share-url') }</div>
        </HelpDisplay>
    </div>

    <div class="block">
        <div class="h">
            <b>{@html __('publish / embed') }</b>
        </div>

        <div class="copy-group">
            <div class="copy-preview">
                <input ref:embedInput type="text" class="embed-code" readonly value="{embedCode}" />
            </div>

            <button
                class="btn copy-button"
                on:click="copy('embedInput')"
                title="{ __('publish / copy') }"
            >
                <i class="fa fa-copy"></i>
            </button>
        </div>
        <div class="copy-success {copySuccess ? 'show':''}">
            { __('publish / copy-success') }
        </div>

        <RadioControl options="{embedOptions}" bind:value="embedType" label="" />
    </div>
    <HelpDisplay>
        <div>
            {@html __('publish / embed / help') } {#each embedTemplates.slice(2) as tpl}
            <div><b>{tpl.title}:</b> {@html purifyHtml(tpl.text) }</div>
            {/each}
        </div>
    </HelpDisplay>
</div>

<style>
    .copy-success {
        font-size: 11px;
        color: #9c9;
        font-style: italic;
        opacity: 0;
        pointer-events: none;
        transition: opacity 5s ease-in;
        margin-top: -10px;
        position: absolute;
    }

    .copy-success.show {
        opacity: 1;
        transition: opacity 5s ease-in;
    }

    .copy-group {
        display: flex;
    }

    .copy-preview {
        flex: 1;
        background: #f5f5f5;
        border: 1px solid #dddddd;
        border-radius: 4px;
    }

    .copy-button {
        flex: 0 0 40px;
        margin-left: 5px;
    }

    .embed-code {
        color: #4f4f4f;
        background: transparent;
        border: none;
        font-size: 12px;
        margin: 0;
        width: calc(100% - 15px);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
    }
</style>

<script>
    import HelpDisplay from '@datawrapper/controls/HelpDisplay.html';
    import RadioControl from '@datawrapper/controls/RadioControl.html';
    import purifyHtml from '@datawrapper/shared/purifyHtml';
    import { __ } from '@datawrapper/shared/l10n';
    import { trackEvent } from '@datawrapper/shared/analytics';
    import get from '@datawrapper/shared/get';

    export default {
        components: {
            HelpDisplay,
            RadioControl
        },
        data() {
            return {
                embedTemplates: [],
                pluginShareurls: [],
                published: false,
                shareurlType: 'default',
                embedType: 'responsive',
                copySuccess: false
            };
        },
        computed: {
            shareUrl({ shareurlType, id, publicUrl, metadata, pluginShareurls, published }) {
                if (!published) return 'https://www.datawrapper.de/...';
                if (shareurlType === 'default') return publicUrl;
                let url = '';

                pluginShareurls.forEach(t => {
                    if (t.id === shareurlType) {
                        url = t.url.replace(/%chart_id%/g, id);

                        url = url.replace(/%(.*?)%/g, (match, path) => {
                            return get({ id, metadata }, path);
                        });
                    }
                });
                return url;
            },
            embedCode({ embedType, publicUrl, metadata }) {
                if (!metadata) return '';
                if (metadata.publish && !metadata.publish['embed-codes']) {
                    return `<iframe src="${publicUrl}" width="100%" height="${metadata.publish['embed-height']}" scrolling="no" frameborder="0" allowtransparency="true"></iframe>`;
                }
                if (metadata.publish['embed-codes']['embed-method-' + embedType]) {
                    return metadata.publish['embed-codes']['embed-method-' + embedType];
                } else {
                    return '';
                }
            },
            shareOptions({ pluginShareurls }) {
                const defaultOption = {
                    label: __('publish / share-url / fullscreen'),
                    value: 'default'
                };

                const pluginShareOptions = pluginShareurls.map(({ name, id }) => ({
                    label: name,
                    value: id
                }));

                return [defaultOption, ...pluginShareOptions];
            },
            embedOptions({ embedTemplates }) {
                return embedTemplates.map(({ title, id }) => ({
                    label: title,
                    value: id
                }));
            }
        },
        helpers: {
            __,
            purifyHtml
        },
        methods: {
            copy(targetRef) {
                const me = this;
                me.refs[targetRef].select();
                try {
                    var successful = document.execCommand('copy');
                    if (successful) {
                        trackEvent('Chart Editor', 'embedcode-copy');
                        me.set({ copySuccess: true });
                        setTimeout(() => me.set({ copySuccess: false }), 300);
                    }
                } catch (err) {
                    // console.log('Oops, unable to copy');
                }
            }
        }
    };
</script>
