{% extends "chart-editor.twig" %}
{% block content %}

{{ parent() }}

{% set vismeta = chart.metadata.visualize %}

<script type="text/javascript">
$(function() {

    var _typeHasChanged = false, _themeHasChanged = false;

    DW.currentChart.onSave(function(chart) {

        $('#iframe-vis').attr('src', '/chart/{{ chart.id }}/preview?nocache='+Math.random());

        if (_themeHasChanged) {
            _themeHasChanged = false;
            $("#iframe-vis").load(updateVisBackground);
        }

        if (_typeHasChanged) {
            // load new visualization options
            $('#vis-options').load('/xhr/'+chart.get('id')+'/vis-options?nocache='+Math.random());
            _typeHasChanged = false;
        }

    });

    DW.currentChart.sync('#select-vis', 'type');
    DW.currentChart.sync('#select-theme', 'theme');
    DW.currentChart.sync('#text-title', 'title');
    DW.currentChart.sync('#text-intro', 'metadata.describe.intro');

    DW.currentChart.onChange(function(chart, key, value) {
        if (key == 'type') {
            _typeHasChanged = true;
        } else if (key == 'theme') {
            _themeHasChanged = true;
        }
    });

    // load dataset
    function _getHighlights() {
        var sel = DW.currentChart.get('metadata.visualize.highlighted-series');
        return _.isArray(sel) ? sel.slice() : [];
    }

    function highlightSeriesClick(e) {
        var badge = $(e.target).parents('.badge'),
            series = badge.data('series'),
            li = badge;
            selected = _getHighlights();
        selected = _.without(selected, series);
        DW.currentChart.set('metadata.visualize.highlighted-series', selected);
        li.remove();
    }
    $('.highlighted-series .badge').click(highlightSeriesClick);

    DW.currentChart.dataset(function(ds) {
        var s = $('#highlight-series'), s2 = $('.highlighted-series');
        _.each(DW.currentChart.dataSeries(), function(col) {
            s.append('<option>'+col.name+'</option>');
        });
        s.change(function() {
            if (s.val() != "---") {
                var selected = _getHighlights();
                if (_.indexOf(selected, s.val()) >= 0) {
                    s.val('---');
                    return;
                }

                var li = $('<span data-series="'+s.val()+'" class="badge badge-info"><i class="icon-remove icon-white"></i>'+s.val()+'</span>');

                selected.push(s.val());

                DW.currentChart.set('metadata.visualize.highlighted-series', selected);

                $('.badge', li).click(highlightSeriesClick);
                s2.append(li);
                s.val('---');
            }
        })
    });

    $('.collapse').on('shown', function(e) {
        var tgl = $('[data-toggle=collapse][data-target=#'+e.target.id+']');
        tgl.addClass('collapse-shown');
        tgl.removeClass('collapse-hidden');
    });

    $('.collapse').on('hidden', function(e) {
        var tgl = $('[data-toggle=collapse][data-target=#'+e.target.id+']');
        tgl.addClass('collapse-hidden');
        tgl.removeClass('collapse-shown');
    });

    function updateVisBackground() {
        var bgcol =  $('body', $('#iframe-vis').contents()).css('background-color'),
            white = bgcol == 'rgb(255, 255, 255)' || bgcol == '#ffffff' || bgcol == 'white' || bgcol == 'transparent',
            border = white ? '#ffffff' : '#bbb';

        $('#iframe-wrapper').css({
            'background-color': white ? '#ffffff' : bgcol,
            'border-color': border
        })
    }

    $('#iframe-vis').load(updateVisBackground);
});

</script>

<div class="dw-create-visualize">

    <div class="row">
        <div class="span8">

            <div id="iframe-wrapper" style="height:500px;">
                <iframe src="/chart/{{ chart.id }}/preview" id="iframe-vis">
                </iframe>
            </div>

        </div>


        <div class="span4 visconfig"><div class="well">
            <div class="section">
                <h3>{% trans "Select visualization and layout" %}</h3>
                
                    <div class="half">
                        <label for="select-vis">{% trans "Visualization:" %}</label>
                        <select id="select-vis">
                            {% for vis in visualizations %}{% if vis.title %}
                            <option value="{{ vis.id }}">{{ vis.title.en }}</option>
                            {% endif %}{% endfor %}
                        </select>
                    </div>

                    <div class="half">
                        <label for="select-theme">Layout:</label>
                        <select id="select-theme">
                            {% for theme in themes %}
                            <option value="{{ theme.id }}">{{ theme.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                <div class="clearfix"></div>
            </div>

            <div class="section">
                <h3>{% trans "Tell your story" %}</h3>

                <label for="text-title">{% trans "Title" %}</label>
                <input type="text" id="text-title" class="input-xlarge span4" />

                {# add introduction #}

                <label for="text-intro"><a data-toggle="collapse" data-target="#c-intro" class="collapse-{% if chart.metadata.describe.intro %}shown{% else %}hidden{% endif %}">Introduction text</a></label>
                <div id="c-intro" class="collapse{% if chart.metadata.describe.intro %} in{% endif %}">
                        <textarea type="text" id="text-intro" class="input-xlarge span4"></textarea>
                </div>

                {# highlight series #}

                <label>
                    <a data-toggle="collapse" data-target="#c-highlight" class="collapse-{% if vismeta['highlighted-series'] %}shown{% else %}hidden{% endif %}">Highlight series</a>
                </label>
                <div class="collapse{% if vismeta['highlighted-series'] %} in{% endif %}" id="c-highlight">
                    <div>
                        <select id="highlight-series" class="span2">
                            <option value="---">- {% trans "select a data series" %} -</option>
                        </select>
                    </div>
                    <p class="highlighted-series">
                        {% for series in vismeta['highlighted-series'] %}
                        <span data-series="{{ series }}" class="badge badge-info"><i class="icon-remove icon-white"></i>{{ series }}</span>
                        {% endfor %}
                    </p>
                </div>

                {# highlight values }

                <label>
                    <a data-toggle="collapse" data-target="#c-highlight-values" class="collapse-{% if vismeta.highlighted-values %}shown{% else %}hidden{% endif %}">Highlight values</a>
                </label>
                <div class="collapse{% if vismeta.highlighted-values %} in{% endif %}" id="c-highlight-values">
                    <div class="form-horizontal">
                        <label>Value: <input type="text" class="span1" /> <input type="text" class="span2" placeholder="comment" /></label>
                    </div>
                </div>

                {# customize tooltips }

                <label><a data-toggle="collapse" data-target="#c-tooltips">{% trans "Customize Tooltips" %}</a></label>
                <div class="collapse" id="c-tooltips">
                    <label class="control-label">{% trans "Tooltip content" %}</label>
                    <div class="controls">
                        <textarea style="width:100%" placeholder="not implemented yet"></textarea>
                    </div>
                </div>

                #}
            </div>

            {# visualization specific options #}

            <div class="section">
                <h3>{% trans "Refine the chart" %}</h3>

                <div id="vis-options" class="form-horizontal">
                    {% use 'vis-options.twig' %}
                    {{ block('visoptions') }}
                </div>
            </div>

            <a href="publish" class="pull-right btn btn-primary btn-large" id="visualize-proceed">Publish <i class="icon-chevron-right icon-white"></i></a>
            <a class="btn" href="describe"><i class="icon-chevron-left"></i> {% trans "Back" %}</a>
            <div class="clearfix"></div>
        </div></div>



    </div>



</div>


{% endblock %}