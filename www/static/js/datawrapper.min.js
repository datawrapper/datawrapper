//      Datawrapper
(function(){var e=this,t;typeof exports!="undefined"?t=exports:t=e.Datawrapper={Parsers:{}},t.VERSION="0.7.1";var n=t.Core=function(){};_.extend(n,{initialize:function(){this.initLanguageLinks()},initLanguageLinks:function(){$("a[href|=#lang]").click(function(e){e.preventDefault(),$.ajax({url:"/api/account/lang",type:"PUT",data:JSON.stringify({lang:$(e.target).attr("href").substr(6)}),processData:!1,success:function(e){location.reload()}})})}})}).call(this),function(){var e=Datawrapper.Dataset=function(e){_.extend(e,{type:"delimited"}),this.__options=e};_.extend(e.prototype,{_initialize:function(){var e=this,t=e.__options},_fetchDelimited:function(e){var t=this,n=t.__options;n.url!==undefined&&(t.__lastUrl==n.url?loaded(t.__rawData):$.ajax({url:n.url,method:"GET",dataType:"text",success:function(n){t._delimtedLoaded(n),_.isFunction(e.success)&&e.success()}}))},_delimtedLoaded:function(e,t){var n=this,r=n.__options;n.__rawData=e;var i=new Datawrapper.Parsers.Delimited(r),s=i.parse(e);n._processData(s),n.__data=s,n.__loaded=!0},_processData:function(e){var n=this,r=new t;n.__seriesByName={},_.each(e.series,function(e){n.__seriesByName[e.name]=e,e._min=function(){return e.min},e._max=function(){return e.max},_.each(e.data,function(e){r.learn(e)})}),_.each(e.series,function(e){e.min=Number.MAX_VALUE,e.max=-Number.MAX_VALUE,e.total=0,_.each(e.data,function(t,n){e.data[n]=r.parse(t),isNaN(e.data[n])||(e.min=Math.min(e.min,e.data[n]),e.max=Math.max(e.max,e.data[n]),e.total+=e.data[n])})})},fetch:function(e){var t=this,n=t.__options;n.type=="delimited"&&t._fetchDelimited(e)},fetchRaw:function(){var e=this,t=e.__options;t.type=="delimited"&&e._delimtedLoaded(t.rawData)},series:function(e){var t=this;if(_.isString(e)){if(t.__seriesByName[e]!==undefined)return t.__seriesByName[e];throw'No series found with that name: "'+e+'"'}if(e!==undefined){if(t.__data.series[e]!==undefined)return t.__data.series[e];throw"No series found with that index: "+e}return this.__data.series},hasRowNames:function(){return this.__data.rowNames!==undefined},numRows:function(){return this.__data.series[0].data.length},eachRow:function(e){var t;for(t=0;t<this.numRows();t++)e(t)},eachSeries:function(e){_.each(this.series(),e)},rowNames:function(){return this.__data.rowNames},rowName:function(e){return this.__data.rowNames[e]},rowNameLabel:function(){return this.__data.rowNameLabel!==undefined?this.__data.rowNameLabel:""},filterRows:function(e){this.eachSeries(function(t){var n=[];t.total=0,t.min=Number.MAX_VALUE,t.max=Number.MAX_VALUE*-1,_.each(e,function(e){n.push(t.data[e]),t.total+=t.data[e],t.min=Math.min(t.min,t.data[e]),t.max=Math.max(t.max,t.data[e])}),t.data=n})}});var t=function(){this.__numbers=[],this.__knownFormats={"-.":/^[\-\.]?[0-9]+(\.[0-9]+)?$/,"-,":/^[\-,]?[0-9]+(,[0-9]+)?$/,",.":/^[0-9]{1,3}(,[0-9]{3})(\.[0-9]+)?$/,".,":/^[0-9]{1,3}(\.[0-9]{3})(,[0-9]+)?$/," .":/^[0-9]{1,3}( [0-9]{3})(\.[0-9]+)?$/," ,":/^[0-9]{1,3}( [0-9]{3})(,[0-9]+)?$/}};_.extend(t.prototype,{learn:function(e){this.__numbers.push(e)},_getFormat:function(){var e=this,t={},n=["",0];return _.each(e.__numbers,function(r){_.each(e.__knownFormats,function(e,i){t[i]===undefined&&(t[i]=0),e.test(r)&&(t[i]+=1,t[i]>n[1]&&(n[0]=i,n[1]=t[i]))})}),n[0]},parse:function(e){var t=this,n=e,r=this.__format;r===undefined&&(r=this.__format=this._getFormat());if(r[0]==","||r[0]=="."||r[0]==" ")n=n.replace(r[0],"");return r[1]!="."&&(n=n.replace(r[1],".")),n=Number(n),isNaN(n)?e:n}})}.call(this),function(){var e=this,t=e._,n=e.jQuery||e.Zepto||e.ender,r=Datawrapper.UI=function(){this.initialize()};t.extend(r.prototype,{initialize:function(){this.initializeSignUp(),this.initializeLogout(),n("a[data-toggle=modal]").click(function(e){var t=n(e.target),r=n(t.data("target"));r.modal()}),this.Errors={}},checkPasswordStrength:function(e){return!0},checkPassword:function(e,t,r){var i,s;return e===""?(s="#cur-pwd",i=Datawrapper.Messages.provideCurPwd):t.length<4?(s="#pwd",i=Datawrapper.Messages.pwdTooShort):t!=r&&(s="#pwd,#pwd2",i=Datawrapper.Messages.pwdMismatch),i?(DW.logError(i,n(s.split(",")[0]).parents(".control-group")),n(s).parents(".control-group").addClass("error"),!1):!0},clearAlerts:function(){n(".alert").remove(),n(".error").removeClass("error")},refreshHeader:function(){location.reload();return},initializeSignUp:function(){function e(){n.getJSON("/api/auth/salt",function(e){e.status=="ok"&&(n("#btn-register").data("salt",e.data.salt),n(".btn-login").data("salt",e.data.salt),n(".btn-login").data("time",e.data.time))})}function t(e){var t=n(e.target).parents(".login-form"),r=n(".btn-login",t),i=CryptoJS.HmacSHA256,s=n(".login-pwd",t).val(),o=i(i(s,r.data("salt")).toString(),String(r.data("time"))).toString(),u={email:n(".login-email",t).val(),pwhash:o,time:r.data("time")};if(s==="")return n(".login-pwd",t).parent().addClass("error"),!1;n(".control-group",t).removeClass("error"),n.ajax({url:"/api/auth/login",type:"POST",dataType:"json",data:JSON.stringify(u),success:function(e){e.status=="ok"?(n("#dwLoginForm").modal("hide"),n("input",t).val(""),t.data("target")?location.href=t.data("target"):location.reload()):(e.code=="login-invalid"?n(".login-pwd",t).parent().addClass("error"):e.code=="login-email-unknown"&&n(".login-email",t).parent().addClass("error"),DW.logError(e.message,t))}})}n("a[href=#login], a[href=#signup]").click(function(t){n("#dwLoginForm").modal(),n("#dwLoginForm .alert").remove();var r=n(t.target),i=r.attr("href")=="#login";i?n("#dwLoginForm .login-email").focus():(n("#register-email").focus(),n(".row-login").css("opacity",.5),n(".row-login *").click(function(){n(".row-login").css("opacity",1)})),r.data("target")&&n("#dwLoginForm .login-form").data("target",r.data("target"));var s=n("#home-login .login-form .login-email"),o=n("#home-login .login-form .login-pwd");return s.val()!==""&&n("#register-email").val(s.val()),o.val()!==""&&n("#register-pwd").val(o.val()),e(),!1}),e(),n("#btn-register").click(function(){var e=n.trim(n("#register-pwd").val()),t=n.trim(n("#register-pwd-2").val());if(e==t){var r={email:n("#register-email").val(),pwd:CryptoJS.HmacSHA256(e,n("#btn-register").data("salt")).toString(),pwd2:CryptoJS.HmacSHA256(t,n("#btn-register").data("salt")).toString()};n.ajax({url:"/api/users",type:"POST",data:JSON.stringify(r),dataType:"json",context:this,success:function(e){e.status=="ok"?(n(".signup-form input").val(""),DW.logMessage("Yeah, sign up went well! You are logged in now...",".signup-form"),setTimeout(function(){n("#dwLoginForm").modal("hide"),DW.refreshHeader()},1e3)):DW.logError(e.code,".signup-form")}})}else alert("Error: password mismatch")}),n(".btn-login").click(t),n(".login-form input").keyup(function(e){e.keyCode==13&&t(e)})},initializeLogout:function(){n("a[href=#logout]").click(function(){return n.ajax({url:"/api/auth/logout",type:"POST",success:function(e){location.href="/"}}),!1})},logMessage:function(e,r,i){t.isFunction(r.prepend)||(r=n(r)),n(".alert",r).remove(),i===undefined&&(i="success");var s=n('<div class="alert alert-'+i+'" />');s.append('<a class="close" data-dismiss="alert" href="#">&times;</a>'),s.append("<div>"+e+"</div>"),r.prepend(s),n(".alert").alert()},logError:function(e,t){this.logMessage(e,t,"error")}}),n(function(){window.DW=new Datawrapper.UI})}.call(this),function(){var e=Datawrapper.Chart=function(e){this.__attributes=e};_.extend(e.prototype,{get:function(e,t){var n=e.split("."),r=this.__attributes;return _.each(n,function(e){if(r===undefined)return t;r=r[e]}),_.isUndefined(r)||_.isNull(r)?t:r},dataset:function(e,t){var n=this,r,i={delimiter:"auto",url:"data",transpose:t?!1:this.get("metadata.data.transpose",!1),firstRowIsHeader:this.get("metadata.data.horizontal-header",!0),firstColumnIsHeader:this.get("metadata.data.vertical-header",!0)};return n.__dataset=r=new Datawrapper.Dataset(i),r.fetch({success:function(){e(r);if(n.__datasetLoadedCallbacks)for(var t=0;t<n.__datasetLoadedCallbacks.length;t++)n.__datasetLoadedCallbacks[t](n)}}),r},rawData:function(e){var t=this,n={rawData:e,delimiter:"auto",transpose:this.get("metadata.data.transpose",!1),firstRowIsHeader:this.get("metadata.data.horizontal-header",!0),firstColumnIsHeader:this.get("metadata.data.vertical-header",!0)};t.__dataset=ds=new Datawrapper.Dataset(n),ds.fetchRaw()},datasetLoaded:function(e){var t=this;t.__dataset.__loaded?e(t):(t.__datasetLoadedCallbacks||(t.__datasetLoadedCallbacks=[]),t.__datasetLoadedCallbacks.push(e))},dataSeries:function(e,t){var n=this;return ds=[],n.__dataset.eachSeries(function(e,t){ds.push(e)}),e&&(ds=ds.sort(function(e,t){return t.data[0]>e.data[0]?1:-1})),t&&ds.reverse(),ds},seriesByName:function(e){return this.__dataset.series(e)},numRows:function(){return this.__dataset.numRows()},hasColHeader:function(e){var t=this.get("metadata.data.transpose");return(e?!t:t)?this.get("metadata.data.vertical-header"):this.get("metadata.data.horizontal-header")},hasRowHeader:function(){return this.hasColHeader(!0)},rowHeader:function(){var e=this.__dataset;return this.hasRowHeader()?{data:e.rowNames()}:!1},rowLabels:function(){return this.hasRowHeader()?this.rowHeader().data:null},rowLabel:function(e){return this.hasRowHeader()?this.rowHeader().data[e]:e},hasHighlight:function(){var e=this.get("metadata.visualize.highlighted-series");return _.isArray(e)&&e.length>0},isHighlighted:function(e){if(e===undefined)return!1;var t=this.get("metadata.visualize.highlighted-series");return!_.isArray(t)||t.length===0||_.indexOf(t,e.name)>=0},setLocale:function(e,t){this.locale=e,this.metric_prefix=t},formatValue:function(e,t,n){var r=this,i=r.get("metadata.describe.number-format"),s=Number(r.get("metadata.describe.number-divisor")),o=r.get("metadata.describe.number-append","").replace(" ","&nbsp;"),u=r.get("metadata.describe.number-prepend","").replace(" ","&nbsp;");if(i!="-"){var a=Globalize.culture(r.locale);e=Number(e)/Math.pow(10,s);if(n||e==Math.round(e))i=i.substr(0,1)+"0";e=Globalize.format(e,i)}return t?u+e+o:e},filterRow:function(e){this.__dataset.filterRows([e])},filterRows:function(e){this.__dataset.filterRows(e)},hasMissingValues:function(){var e=!1;return _.each(this.dataSeries(),function(t){_.each(t.data,function(t){if(t!=Number(t))return e=!0,!1});if(e)return!1}),e}})}.call(this),function(){var e=Datawrapper.EditableChart=function(e){var t=this;t.__attributes=e,t.__changed=!1,t.__changeCallbacks=[],t.__saveCallbacks=[],t.__syncedElements=[]};_.extend(e.prototype,Datawrapper.Chart.prototype,{set:function(e,t){var n=e.split("."),r=this,i=n.pop(),s=r.__attributes;return _.each(n,function(e){_.isArray(s[e])&&s[e].length===0&&(s[e]={}),s=s[e]}),s[i]!=t&&(s[i]=t,r.__changed=!0,clearTimeout(r.__saveTimeout),r.__saveTimeout=setTimeout(function(){r.save()},300),_.each(r.__changeCallbacks,function(n){n.call(this,r,e,t)})),this},onChange:function(e){this.__changeCallbacks.push(e)},sync:function(e,t,n){function s(e){var t,n;t=e.data("sync-attribute"),e.is("input[type=checkbox]")?n=e.attr("checked")=="checked":e.is("input[type=text]")||e.is("textarea")||e.is("select")?n=e.val():e.is("input[type=radio]")&&(n=$("input:radio[name="+e.attr("name")+"]:checked").val(),n==="yes"?n=!0:n==="no"&&(n=!1)),n!==undefined&&i.set(t,n)}_.isString(e)&&(e=$(e)),e.data("sync-attribute",t);var r=this.get(t,n);e.is("input[type=checkbox]")?r?e.attr("checked","checked"):e.removeAttr("checked"):e.is("input[type=text]")||e.is("textarea")||e.is("select")?e.val(r):e.is("input[type=radio]")&&(_.isBoolean(r)&&(r=r?"yes":"no"),$("input:radio[name="+e.attr("name")+"][value="+r+"]").attr("checked","checked"));var i=this;i.__syncedElements.push(e),e.change(function(e){s($(e.target))}),window.onbeforeunload=function(e){if(i.__changed)return"Caution: unsaved changes"}},onSave:function(e){this.__saveCallbacks.push(e)},save:function(e){if(!this.__changed)return!1;clearTimeout(this.__saveTimeout);var t=this;return $.ajax({url:"/api/charts/"+this.get("id"),type:"PUT",dataType:"json",data:JSON.stringify(this.__attributes),processData:!1,context:this,success:function(e){e.status=="ok"?(this.__changed=!1,_.each(this.__saveCallbacks,function(e){e.call(this,t)})):console.warn("could not save the chart",e)}}),!0}})}.call(this),function(){Datawrapper.Themes={},Datawrapper.Themes.Base=_.extend({},{colors:{palette:["#6E7DA1","#64A4C4","#53CCDD","#4EF4E8"],positive:"#85B4D4",negative:"#E31A1C",background:"#ffffff",text:"#000000"},locale:"de_DE",lineChart:{strokeWidth:{highlight:3,normal:1},hoverDotRadius:3,maxLabelWidth:80,fillOpacity:.2},barChart:{},columnChart:{cutGridLines:!1},horizontalGrid:{stroke:"#e9e9e9"},yTicks:!1,xAxis:{stroke:"#333"},yAxis:{"stroke-width":1},padding:{left:0,right:20,bottom:30,top:10},leftPadding:20,rightPadding:20,lineLabelWidth:20,yLabelOffset:8,bottomPadding:40,xLabelOffset:20,hover:!0,tooltip:!0,hpadding:0,vpadding:10,minWidth:400})}.call(this),function(){Datawrapper.Parsers.Delimited=function(e){e=e||{},this.delimiter=e.delimiter||",",this.quoteChar=e.quoteChar||'"',this.skipRows=e.skipRows||0,this.emptyValue=e.emptyValue||null,this.transpose=e.transpose||!1,this.firstRowIsHeader=e.firstRowIsHeader!==undefined?e.firstRowIsHeader:!0,this.firstColumnIsHeader=e.firstRowIsHeader!==undefined?e.firstColumnIsHeader:!0,this.getDelimiterPatterns=function(e,t){return new RegExp("(\\"+e+"|\\r?\\n|\\r|^)"+"(?:"+t+"([^"+t+"]*(?:"+t+'"[^'+t+"]*)*)"+t+"|"+"([^"+t+"\\"+e+"\\r\\n]*))","gi")},this.__delimiterPatterns=this.getDelimiterPatterns(this.delimiter,this.quoteChar)},_.extend(Datawrapper.Parsers.Delimited.prototype,Datawrapper.Parsers.prototype,{parse:function(e){this.__rawData=e,this.delimiter=="auto"&&(this.delimiter=this.guessDelimiter(e,this.skipRows),this.__delimiterPatterns=this.getDelimiterPatterns(this.delimiter,this.quoteChar));var t=[],n=this.delimiter!="|"?"|":"#",r;e=n+e.replace(/\s+$/g,"")+n;var i=function(e,t,r){r=r||",";var i=[[]],s=null,o;while(s=e.exec(t)){var u=s[1];u.length&&u!=r&&i.push([]),s[2]?o=s[2].replace(new RegExp('""',"g"),'"'):o=s[3],i[i.length-1].push(o)}i[0][0].substr(0,1)==n&&(i[0][0]=i[0][0].substr(1));var a=i.length-1,f=i[a].length-1,l=i[a][f].length-1;return i[a][f].substr(l)==n&&(i[a][f]=i[a][f].substr(0,l)),i},s=function(e){var t=e,n=t.length?t.length:0,r=t[0]instanceof Array?t[0].length:0;if(r===0||n===0)return[];var i,s,o=[];for(i=0;i<r;i++){o[i]=[];for(s=0;s<n;s++)o[i][s]=t[s][i]}return o};parseDataArray=function(e,t,n,r,i){var s=[],o={},u=e.length,a=e[0].length,f=t,l=[];r&&(l=e[f],f++);for(var c=0;c<a;c++){var h=_.isString(l[c])?l[c].replace(/^\s+|\s+$/g,""):"",p=h!==""?"":1;h=h!==""?h:"X.";while(o[h+p]!==undefined)p=p===""?1:p+1;s.push({name:h+p,data:[]}),o[h+p]=!0}for(;f<u;f++)_.each(s,function(t,r){t.data.push(e[f][r]!==""?e[f][r]:n)});var d;return i&&(d=s[0],s=s.slice(1)),{series:s,rowNames:d?d.data:undefined,rowNameLabels:d?d.name:undefined}},r=i(this.__delimiterPatterns,e,this.delimiter);if(this.transpose){r=s(r);var o=this.firstRowIsHeader;this.firstRowIsHeader=this.firstColumnIsHeader,this.firstColumnIsHeader=o}return parseDataArray(r,this.skipRows,this.emptyValue,this.firstRowIsHeader,this.firstColumnIsHeader)},guessDelimiter:function(e){var t=0,n=-1,r=this,i=["	",";","|",","];return _.each(i,function(i,s){var o=r.getDelimiterPatterns(i,r.quoteChar),u=e.match(o).length;u>t&&(t=u,n=s)}),i[n]}})}(this,_),function(){Datawrapper.Visualizations={};var e=function(){};_.extend(e.prototype,{render:function(e){$(e).html("implement me!")},setTheme:function(e){return this.theme=e,this},setSize:function(e,t){var n=this;return n.__w=e,n.__h=t,n},load:function(e,t){var n=this;this.chart=e,e.dataset(function(e){n.dataset=e,t.call(n,n)})},getMaxChartHeight:function(e){function t(e,t){return+$(e).css("margin-"+t).replace("px","")}var n=0,r=0;$("body > *").each(function(e,i){var s=i.tagName.toLowerCase();s!="script"&&i.id!="chart"&&!$(i).hasClass("tooltip")&&!$(i).hasClass("container")&&(n+=$(i).outerHeight(!1)),n+=Math.max(t(i,"top"),r),r=t(i,"bottom")}),n+=r;var i=$("#chart").css("margin-top").replace("px",""),s=$("#chart").css("margin-bottom").replace("px",""),o=$(window).height()-n-2;return $.browser.msie&&(o-=10),o-=$("body").css("padding-top").replace("px",""),o-=$("body").css("padding-bottom").replace("px",""),o},get:function(e,t){return this.chart.get("metadata.visualize."+e,t)},warn:function(e){var t=$("<div>"+e+"</div>");t.css({"background-color":"#FCF8E3",border:"1px solid #FBEED5","border-radius":"4px 4px 4px 4px",color:"#a07833","margin-bottom":"18px",padding:"8px 35px 8px 14px","text-shadow":"0 1px 0 rgba(255, 255, 255, 0.5)",left:"10%",right:"10%","text-align":"center",position:"absolute"}),$("body").prepend(t),t.hide(),t.fadeIn()}}),Datawrapper.Visualizations.Base=e.prototype}.call(this),function(){var AJAX_ACCOUNT,AJAX_RESET_PASSWORD,AJAX_SALT,AJAX_USERS,Widget,isDefined,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__indexOf=Array.prototype.indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},__hasProp=Object.prototype.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},_this=this;window.serious={},window.serious.Utils={},isDefined=function(e){return typeof e!="undefined"&&e!==null},jQuery.fn.opacity=function(e){return $(this).css({opacity:e})},window.serious.Utils.clone=function(e){var t,n,r;if(e==null||typeof e!="object")return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return t="",e.global!=null&&(t+="g"),e.ignoreCase!=null&&(t+="i"),e.multiline!=null&&(t+="m"),e.sticky!=null&&(t+="y"),new RegExp(e.source,t);r=new e.constructor;for(n in e)r[n]=window.serious.Utils.clone(e[n]);return r},jQuery.fn.cloneTemplate=function(e,t){var n,r,i;t==null&&(t=!1),r=$(this[0]).clone(),r=r.removeClass("template hidden").addClass("actual");if(typeof e=="object"){for(n in e)i=e[n],i!==null&&r.find(".out."+n).html(i);t&&r.find(".out").each(function(){if($(this).html()==="")return $(this).remove()})}return r},window.serious.Widget=function(){function Widget(){this.cloneTemplate=__bind(this.cloneTemplate,this),this.show=__bind(this.show,this),this.hide=__bind(this.hide,this),this.set=__bind(this.set,this)}return Widget.bindAll=function(){return $(".widget").each(function(){return Widget.ensureWidget($(this))})},Widget.ensureWidget=function(e){var t,n;return e=$(e),e[0]._widget!=null?e[0]._widget:(n=Widget.getWidgetClass(e),n!=null?(t=new n,t.bindUI(e),t):(console.warn("widget not found for",e),null))},Widget.getWidgetClass=function(ui){return eval("("+$(ui).attr("data-widget")+")")},Widget.prototype.bindUI=function(e){var t,n,r,i,s,o,u,a,f;this.ui=$(e),this.ui[0]._widget&&delete this.ui[0]._widget,this.ui[0]._widget=this,this.uis={};if(typeof this.UIS!="undefined"){u=this.UIS;for(n in u)i=u[n],r=this.ui.find(i),r.length<1&&console.warn("uis",n,"not found in",e),this.uis[n]=r}if(typeof this.ACTIONS!="undefined"){a=this.ACTIONS,f=[];for(s=0,o=a.length;s<o;s++)t=a[s],f.push(this._bindClick(this.ui.find(".do[data-action="+t+"]"),t));return f}},Widget.prototype.set=function(e,t,n){return n=n||this.ui,n.find(".out[data-field="+e+"]").html(t),n},Widget.prototype.hide=function(){return this.ui.addClass("hidden")},Widget.prototype.show=function(){return this.ui.removeClass("hidden")},Widget.prototype.cloneTemplate=function(e,t,n){var r,i,s,o,u,a,f,l;n==null&&(n=!1),u=e.clone(),u=u.removeClass("template hidden").addClass("actual");if(typeof t=="object"){for(o in t)a=t[o],a!==null&&u.find(".out."+o).html(a);n&&u.find(".out").each(function(){if($(this).html()==="")return $(this).remove()})}s=u.find(".do");for(f=0,l=s.length;f<l;f++)r=s[f],r=$(r),i=r.data("action"),this._bindClick(r,i);return u},Widget.prototype._bindClick=function(e,t){var n=this;if(t!=null&&__indexOf.call(this.ACTIONS,t)>=0)return e.click(function(e){return n[t](e),e.preventDefault()})},Widget}(),window.serious.URL=function(){function e(){this.toString=__bind(this.toString,this),this.fromString=__bind(this.fromString,this),this.enableLinks=__bind(this.enableLinks,this),this.updateUrl=__bind(this.updateUrl,this),this.hasBeenAdded=__bind(this.hasBeenAdded,this),this.hasChanged=__bind(this.hasChanged,this),this.remove=__bind(this.remove,this),this.update=__bind(this.update,this),this.set=__bind(this.set,this),this.onStateChanged=__bind(this.onStateChanged,this),this.get=__bind(this.get,this);var e=this;this.previousHash=[],this.handlers=[],this.hash=this.fromString(location.hash),$(window).hashchange(function(){var t,n,r,i,s;e.previousHash=window.serious.Utils.clone(e.hash),e.hash=e.fromString(location.hash),i=e.handlers,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t());return s})}return e.prototype.get=function(e){return e==null&&(e=null),e?this.hash[e]:this.hash},e.prototype.onStateChanged=function(e){return this.handlers.push(e)},e.prototype.set=function(e,t){var n,r,i;t==null&&(t=!1),n=t?this.hash:window.serious.Utils.clone(this.hash),n=[];for(r in e)i=e[r],isDefined(i)&&(n[r]=i);return this.updateUrl(n)},e.prototype.update=function(e,t){var n,r,i;t==null&&(t=!1),n=t?this.hash:window.serious.Utils.clone(this.hash);for(r in e)i=e[r],isDefined(i)?n[r]=i:delete n[r];return this.updateUrl(n)},e.prototype.remove=function(e,t){var n;return t==null&&(t=!1),n=t?this.hash:window.serious.Utils.clone(this.hash),n[e]&&delete n[e],this.updateUrl(n)},e.prototype.hasChanged=function(e){return this.hash[e]!=null?this.previousHash[e]!=null?this.hash[e].toString()!==this.previousHash[e].toString():!0:this.previousHash[e]!=null?!0:!1},e.prototype.hasBeenAdded=function(e){return console.error("not implemented")},e.prototype.updateUrl=function(e){return e==null&&(e=null),location.hash=this.toString(e)},e.prototype.enableLinks=function(e){var t=this;return e==null&&(e=null),$("a.internal[href]",e).click(function(e){var n,r;return r=$(e.currentTarget),n=r.attr("data-href")||r.attr("href"),n[0]==="#"&&(n.length>1&&n[1]==="+"?t.update(t.fromString(n.slice(2))):n.length>1&&n[1]==="-"?t.remove(t.fromString(n.slice(2))):t.set(t.fromString(n.slice(1)))),!1})},e.prototype.fromString=function(e){var t,n,r,i,s,o,u;e=e||location.hash,t=[],e=e.split("&");for(o=0,u=e.length;o<u;o++)n=e[o],n!=null&&(i=n.split("="),i.length===2&&(r=i[0].replace("#",""),s=i[1].replace("#",""),t[r]=s));return t},e.prototype.toString=function(e){var t,n,r;e==null&&(e=null),e=e||this.hash,n="";for(t in e)r=e[t],n+="&"+t+"="+r;return n},e}(),window.datawrapper={},Widget=window.serious.Widget,AJAX_USERS="/api/users",AJAX_SALT="/api/auth/salt",AJAX_ACCOUNT="/api/account",AJAX_RESET_PASSWORD="/api/account/reset-password",datawrapper.AdminUsers=function(e){function t(){this.getUserById=__bind(this.getUserById,this),this.getCurrentUser=__bind(this.getCurrentUser,this),this.getSalt=__bind(this.getSalt,this),this.toggleAdmin=__bind(this.toggleAdmin,this),this.deleteUser=__bind(this.deleteUser,this),this.addUser=__bind(this.addUser,this),this.getUsers=__bind(this.getUsers,this),this.toggleAdminAction=__bind(this.toggleAdminAction,this),this.deleteAction=__bind(this.deleteAction,this),this.addUserAction=__bind(this.addUserAction,this),this.disableLoading=__bind(this.disableLoading,this),this.enableLoading=__bind(this.enableLoading,this),this.hideMessages=__bind(this.hideMessages,this),this.onUsersLoaded=__bind(this.onUsersLoaded,this),this.fabricUserEntry=__bind(this.fabricUserEntry,this),this.showUsers=__bind(this.showUsers,this),this.bindUI=__bind(this.bindUI,this),this.UIS={usersContainer:".users",userTmpl:".user.template",emailField:"input[name=email]",addButton:"input[name=addUser]",statusField:"select[name=status]",msgDeleteSuccess:".delete-succeed",msgError:".alert-error",msgAddSuccess:".add-success",loading:".loading",confirmNewAdmin:".confirm-admin-new",confirmLostAdmin:".confirm-admin-lost",confirmDeleteUser:".confirm-delete"},this.ACTIONS=["addUserAction","deleteAction","toggleAdminAction","getUsers"],this.cache={users:null,salt:null,time:null,currentUser:null}}return __extends(t,e),t.prototype.bindUI=function(e){return t.__super__.bindUI.apply(this,arguments),this.getSalt(),this.getCurrentUser(),this.showUsers()},t.prototype.showUsers=function(e){var t,n,r,i,s,o;e==null&&(e=!1);if(this.cache.users==null||e)return this.cache.users=null,this.getUsers();this.uis.usersContainer.find(".actual").remove(),s=this.cache.users,o=[];for(r=0,i=s.length;r<i;r++)n=s[r],n.Email!=="DELETED"?(t=this.fabricUserEntry(n),o.push(this.uis.usersContainer.prepend(t))):o.push(void 0);return o},t.prototype.fabricUserEntry=function(e){var t;return t=this.cloneTemplate(this.uis.userTmpl,{id:e.Id,email:e.Email,status:e.Role,creation:e.CreatedAt}).attr("data-userid",e.Id),e.ActivateToken!==null&&e.ActivateToken!==""&&t.addClass("pending"),e.Role==="admin"?(t.addClass("admin"),t.find("input[name=isAdmin]").prop("checked",!0)):t.find("input[name=isAdmin]").prop("checked",!1),e.Id===this.cache.currentUser.Id&&t.find(".action").addClass("hidden"),t},t.prototype.onUsersLoaded=function(e){return this.cache.users=e.data,this.showUsers()},t.prototype.hideMessages=function(){return this.uis.msgAddSuccess.addClass("hidden"),this.uis.msgDeleteSuccess.addClass("hidden"),this.uis.msgError.addClass("hidden")},t.prototype.enableLoading=function(){return this.uis.loading.removeClass("hidden"),this.uis.addButton.prop("disabled",!0)},t.prototype.disableLoading=function(){return this.uis.loading.addClass("hidden"),this.uis.addButton.prop("disabled",!1)},t.prototype.addUserAction=function(e){var t,n;return this.hideMessages(),t=this.uis.emailField.val(),n=this.uis.statusField.val(),this.addUser(t,n)},t.prototype.deleteAction=function(e){var t;return this.hideMessages(),t=$(e.currentTarget).parents(".user").attr("data-userid"),this.deleteUser(t)},t.prototype.toggleAdminAction=function(e){var t,n;this.hideMessages(),t=$(e.currentTarget).parents(".user").attr("data-userid"),n=this.getUserById(t);if(n.Role==="admin"){if(confirm(""+n.Email+" "+this.uis.confirmLostAdmin.text()))return this.toggleAdmin(t,!1)}else if(confirm(""+n.Email+" "+this.uis.confirmNewAdmin.text()))return this.toggleAdmin(t,!0)},t.prototype.getUsers=function(){return $.ajax(AJAX_USERS,{dataType:"json",success:this.onUsersLoaded})},t.prototype.addUser=function(e,t){var n=this;return this.enableLoading(),$.ajax(AJAX_USERS,{dataType:"json",type:"POST",data:JSON.stringify({email:e,role:t,invitation:!0}),success:function(e){var t,r,i;return n.disableLoading(),e.status==="ok"?(i=e.data,n.set("email",i.Email,n.uis.msgAddSuccess),n.uis.msgAddSuccess.removeClass("hidden"),t=n.fabricUserEntry(i).addClass("warning"),n.uis.usersContainer.prepend(t),n.cache.users.push(i),n.uis.emailField.val("")):e.status==="error"?(n.uis.msgError.filter(".error-"+e.message).removeClass("hidden"),n.showUsers(r=!0)):n.showUsers(r=!0)}})},t.prototype.deleteUser=function(e){var t,n=this;t=this.getUserById(e);if(confirm(""+t.Email+" "+this.uis.confirmDeleteUser.text()))return $.ajax(""+AJAX_USERS+"/"+e,{dataType:"json",type:"DELETE",success:function(e){var r;if(e.status==="ok")return n.showUsers(r=!0),n.set("email",t.Email,n.uis.msgDeleteSuccess),n.uis.msgDeleteSuccess.removeClass("hidden")}})},t.prototype.toggleAdmin=function(e,t){var n,r,i=this;return t==null&&(t=!1),r=this.getUserById(e),n=t?"admin":"editor",$.ajax(""+AJAX_USERS+"/"+e,{dataType:"json",type:"PUT",data:JSON.stringify({role:n}),success:function(t){var s;if(t.status==="ok"&&__indexOf.call(t.data.updated,"role")>=0)return r.Role=n,s=i.uis.usersContainer.find("[data-userid="+e+"]"),s.replaceWith(i.fabricUserEntry(r))}})},t.prototype.getSalt=function(){var e=this;return $.ajax(AJAX_SALT,{dataType:"json",success:function(t){if(t.status==="ok")return e.cache.salt=t.data.salt}})},t.prototype.getCurrentUser=function(){var e=this;return $.ajax(AJAX_ACCOUNT,{dataType:"json",async:!1,success:function(t){if(t.status==="ok")return e.cache.currentUser=t.data.user}})},t.prototype.getUserById=function(e){var t,n,r,i;i=this.cache.users;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.Id===parseInt(e))return t}return null},t}(Widget),datawrapper.InvitationForm=function(e){function t(){this.getSalt=__bind(this.getSalt,this),this.send=__bind(this.send,this),this.bindUI=__bind(this.bindUI,this),this.UIS={pwd1:"input[name=password1]",pwd2:"input[name=password2]",msgError:".error"},this.ACTIONS=["send"],this.cache={salt:null}}return __extends(t,e),t.prototype.bindUI=function(e){return t.__super__.bindUI.apply(this,arguments),this.getSalt()},t.prototype.send=function(){var e,t,n=this;return this.uis.msgError.addClass("hidden"),e=this.uis.pwd1.val()!==""?CryptoJS.HmacSHA256(this.uis.pwd1.val(),this.cache.salt).toString():"",t=this.uis.pwd2.val()!==""?CryptoJS.HmacSHA256(this.uis.pwd2.val(),this.cache.salt).toString():"",$.ajax("/api"+document.location.pathname,{dataType:"json",type:"POST",data:JSON.stringify({pwd1:e,pwd2:t}),success:function(e){return e.status==="ok"?window.location="/":n.uis.msgError.removeClass("hidden").find("div").text(e.message)}})},t.prototype.getSalt=function(){var e=this;return $.ajax(AJAX_SALT,{dataType:"json",success:function(t){if(t.status==="ok")return e.cache.salt=t.data.salt}})},t}(Widget),$(document).ready(function(){return Widget.bindAll()})}.call(this);