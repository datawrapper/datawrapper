!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@datawrapper/controls")):"function"==typeof define&&define.amd?define("svelte/fields",["@datawrapper/controls"],e):(t=t||self).fields=e(t.controls)}(this,(function(t){"use strict";function e(){}function n(t,e){for(var n in e)t[n]=e[n];return t}function i(t,e){for(var n in e)t[n]=1;return t}function o(t,e){t.appendChild(e)}function s(t,e,n){t.insertBefore(e,n)}function r(t){t.parentNode.removeChild(t)}function c(t){return document.createElement(t)}function u(t){return document.createTextNode(t)}function a(){return document.createComment("")}function d(t,e,n,i){t.addEventListener(e,n,i)}function f(t,e,n,i){t.removeEventListener(e,n,i)}function l(t,e,n){null==n?t.removeAttribute(e):t.setAttribute(e,n)}function h(){return Object.create(null)}function p(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function m(t,e){return t!=t?e==e:t!==e}function _(t,e){var n=t in this._handlers&&this._handlers[t].slice();if(n)for(var i=0;i<n.length;i+=1){var o=n[i];if(!o.__calling)try{o.__calling=!0,o.call(this,e)}finally{o.__calling=!1}}}function v(t){t._lock=!0,b(t._beforecreate),b(t._oncreate),b(t._aftercreate),t._lock=!1}function g(){return this._state}function y(t,e){var n=this._handlers[t]||(this._handlers[t]=[]);return n.push(e),{cancel:function(){var t=n.indexOf(e);~t&&n.splice(t,1)}}}function b(t){for(;t&&t.length;)t.shift()()}var F={destroy:function(t){this.destroy=e,this.fire("destroy"),this.set=e,this._fragment.d(!1!==t),this._fragment=null,this._state={}},get:g,fire:_,on:y,set:function(t){this._set(n({},t)),this.root._lock||v(this.root)},_recompute:e,_set:function(t){var e=this._state,i={},o=!1;for(var s in t=n(this._staged,t),this._staged={},t)this._differs(t[s],e[s])&&(i[s]=o=!0);o&&(this._state=n(n({},e),t),this._recompute(i,this._state),this._bind&&this._bind(i,this._state),this._fragment&&(this.fire("state",{changed:i,current:this._state,previous:e}),this._fragment.p(i,this._state),this.fire("update",{changed:i,current:this._state,previous:e})))},_stage:function(t){n(this._staged,t)},_mount:function(t,e){this._fragment[this._fragment.i?"i":"m"](t,e||null)},_differs:p};function w(t){var e=t.changed,n=t.current,i=this.store.get().dw_chart;if(e.customFields&&n.customFields){var o=i.get("metadata.custom",{});n.customFields.forEach((function(t){o[t.key]||(o[t.key]="")})),this.set({custom:o,initialized:!0})}e.custom&&n.initialized&&(i.set("metadata.custom",n.custom),i.saveSoon&&i.saveSoon())}function k(t,e,n){var i=Object.create(t);return i.field=e[n],i}function C(t,e){var n,i,a,l,h,p,m=!e.notoggle&&x();function _(e){t.toggle()}for(var v=e.customFields,g=[],y=0;y<v.length;y+=1)g[y]=P(t,k(e,v,y));return{c:function(){n=c("div"),i=c("label"),m&&m.c(),a=u(" Custom fields"),l=u("\n\n    "),h=c("div"),p=c("div");for(var t=0;t<g.length;t+=1)g[t].c();d(i,"click",_),i.className="group-title",h.className="option-group-content vis-option-type-chart-description",n.className="vis-option-type-group group-open"},m:function(e,r){s(e,n,r),o(n,i),m&&m.m(i,null),o(i,a),o(n,l),o(n,h),o(h,p);for(var c=0;c<g.length;c+=1)g[c].m(p,null);t.refs.customFields=p},p:function(e,n){if(n.notoggle?m&&(m.d(1),m=null):m||((m=x()).c(),m.m(i,a)),e.customFields||e.custom){v=n.customFields;for(var o=0;o<v.length;o+=1){var s=k(n,v,o);g[o]?g[o].p(e,s):(g[o]=P(t,s),g[o].c(),g[o].m(p,null))}for(;o<g.length;o+=1)g[o].d(1);g.length=v.length}},d:function(e){e&&r(n),m&&m.d(),f(i,"click",_),function(t,e){for(var n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}(g,e),t.refs.customFields===p&&(t.refs.customFields=null)}}}function x(t,e){var n,i,o;return{c:function(){n=c("i"),i=u("\n        "),o=c("i"),n.className="fa fa-chevron-up expand-group pull-right",o.className="fa fa-chevron-down collapse-group pull-right"},m:function(t,e){s(t,n,e),s(t,i,e),s(t,o,e)},d:function(t){t&&(r(n),r(i),r(o))}}}function N(t,e){var n,i,o,u=!1;function a(){u=!0,e.custom[e.field.key]=n.value,t.set({custom:e.custom,customFields:e.customFields}),u=!1}return{c:function(){d(n=c("textarea"),"input",a),l(n,"labelwidth","auto"),l(n,"label",i=e.field.title),l(n,"help",o=e.field.description)},m:function(t,i){s(t,n,i),n.value=e.custom[e.field.key]},p:function(t,s){e=s,u||!t.custom&&!t.customFields||(n.value=e.custom[e.field.key]),t.customFields&&i!==(i=e.field.title)&&l(n,"label",i),t.customFields&&o!==(o=e.field.description)&&l(n,"help",o)},d:function(t){t&&r(n),f(n,"input",a)}}}function E(e,n){var i={},o={labelWidth:"auto",label:n.field.title,help:n.field.description};void 0!==n.custom[n.field.key]&&(o.value=n.custom[n.field.key],i.value=!0);var s=new t.Text({root:e.root,store:e.store,data:o,_bind:function(t,o){var s={};!i.value&&t.value&&(n.custom[n.field.key]=o.value,s.custom=n.custom),e._set(s),i={}}});return e.root._beforecreate.push((function(){s._bind({value:1},s.get())})),{c:function(){s._fragment.c()},m:function(t,e){s._mount(t,e)},p:function(t,e){n=e;var o={};t.customFields&&(o.label=n.field.title),t.customFields&&(o.help=n.field.description),(!i.value&&t.custom||t.customFields)&&(o.value=n.custom[n.field.key],i.value=void 0!==n.custom[n.field.key]),s._set(o),i={}},d:function(t){s.destroy(t)}}}function P(t,e){var n;function i(t){return"text"==t.field.type?E:"textArea"==t.field.type?N:void 0}var o=i(e),c=o&&o(t,e);return{c:function(){c&&c.c(),n=a()},m:function(t,e){c&&c.m(t,e),s(t,n,e)},p:function(e,s){o===(o=i(s))&&c?c.p(e,s):(c&&c.d(1),(c=o&&o(t,s))&&c.c(),c&&c.m(n.parentNode,n))},d:function(t){c&&c.d(t),t&&r(n)}}}function z(t){var e,o,c,u,d=this;!function(t,e){t._handlers=h(),t._slots=h(),t._bind=e._bind,t._staged={},t.options=e,t.root=e.root||t,t.store=e.store||t.root.store,e.root||(t._beforecreate=[],t._oncreate=[],t._aftercreate=[])}(this,t),this.refs={},this._state=n({customFields:[],custom:{},initialized:!1},t.data),this._intro=!0,this._handlers.state=[w],w.call(this,{changed:i({},this._state),current:this._state}),this._fragment=(e=this,o=this._state,u=o.customFields.length&&o.initialized&&C(e,o),{c:function(){u&&u.c(),c=a()},m:function(t,e){u&&u.m(t,e),s(t,c,e)},p:function(t,n){n.customFields.length&&n.initialized?u?u.p(t,n):((u=C(e,n)).c(),u.m(c.parentNode,c)):u&&(u.d(1),u=null)},d:function(t){u&&u.d(t),t&&r(c)}}),this.root._oncreate.push((function(){d.fire("update",{changed:i({},d._state),current:d._state})})),t.target&&(this._fragment.c(),this._mount(t.target,t.anchor),v(this))}function j(t,e){this._handlers={},this._dependents=[],this._computed=h(),this._sortedComputedProperties=[],this._state=n({},t),this._differs=e&&e.immutable?m:p}n(z.prototype,F),n(j.prototype,{_add:function(t,e){this._dependents.push({component:t,props:e})},_init:function(t){for(var e={},n=0;n<t.length;n+=1){var i=t[n];e["$"+i]=this._state[i]}return e},_remove:function(t){for(var e=this._dependents.length;e--;)if(this._dependents[e].component===t)return void this._dependents.splice(e,1)},_set:function(t,e){var i=this,o=this._state;this._state=n(n({},o),t);for(var s=0;s<this._sortedComputedProperties.length;s+=1)this._sortedComputedProperties[s].update(this._state,e);this.fire("state",{changed:e,previous:o,current:this._state}),this._dependents.filter((function(t){for(var n={},o=!1,s=0;s<t.props.length;s+=1){var r=t.props[s];r in e&&(n["$"+r]=i._state[r],o=!0)}if(o)return t.component._stage(n),!0})).forEach((function(t){t.component.set({})})),this.fire("update",{changed:e,previous:o,current:this._state})},_sortComputedProperties:function(){var t,e=this._computed,n=this._sortedComputedProperties=[],i=h();function o(s){var r=e[s];r&&(r.deps.forEach((function(e){if(e===t)throw new Error("Cyclical dependency detected between "+e+" <-> "+s);o(e)})),i[s]||(i[s]=!0,n.push(r)))}for(var s in this._computed)o(t=s)},compute:function(t,e,i){var o,s=this,r={deps:e,update:function(n,r,c){var u=e.map((function(t){return t in r&&(c=!0),n[t]}));if(c){var a=i.apply(null,u);s._differs(a,o)&&(o=a,r[t]=!0,n[t]=o)}}};this._computed[t]=r,this._sortComputedProperties();var c=n({},this._state),u={};r.update(c,u,!0),this._set(c,u)},fire:_,get:g,on:y,set:function(t){var e=this._state,n=this._changed={},i=!1;for(var o in t){if(this._computed[o])throw new Error("'"+o+"' is a read-only computed property");this._differs(t[o],e[o])&&(n[o]=i=!0)}i&&this._set(t,n)}});return{App:z,data:{chart:{id:""}},store:new j({}),init:function(t){window.dw.backend.on("dataset-loaded",(function(){t.store.set({dataset:chart.dataset()})})).on("theme-changed-and-loaded",(function(){t.store.set({theme:window.dw.theme(chart.get("theme"))})})).on("backend-vis-loaded",(function(e){t.store.set({vis:e})}))}}}));
