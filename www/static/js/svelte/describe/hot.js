!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("Handsontable"),require("@datawrapper/shared/columnFormatter")):"function"==typeof define&&define.amd?define(["Handsontable","@datawrapper/shared/columnFormatter"],e):(t=t||self)["describe/hot"]=e(t.HOT,t.columnFormatter)}(this,(function(t,e){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t;var r=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n};var n=function(t){if(Array.isArray(t))return r(t)};var o=function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)};var a=function(t,e){if(t){if("string"==typeof t)return r(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(t,e):void 0}};var s=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var i=function(t){return n(t)||o(t)||a(t)||s()};var u=function(t){if(Array.isArray(t))return t};var c=function(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var r=[],n=!0,o=!1,a=void 0;try{for(var s,i=t[Symbol.iterator]();!(n=(s=i.next()).done)&&(r.push(s.value),!e||r.length!==e);n=!0);}catch(t){o=!0,a=t}finally{try{n||null==i.return||i.return()}finally{if(o)throw a}}return r}};var l=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var d=function(t,e){return u(t)||c(t,e)||a(t,e)||l()};var h=function(t,e,r){return t(r={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&r.path)}},r.exports),r.exports}((function(t){function e(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=e=function(t){return typeof t}:t.exports=e=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(r)}t.exports=e}));function f(){}function m(t,e){for(var r in e)t[r]=e[r];return t}function p(t,e){for(var r in e)t[r]=1;return t}function v(){return Object.create(null)}function g(t){t._lock=!0,y(t._beforecreate),y(t._oncreate),y(t._aftercreate),t._lock=!1}function y(t){for(;t&&t.length;)t.shift()()}var _={destroy:function(t){this.destroy=f,this.fire("destroy"),this.set=f,this._fragment.d(!1!==t),this._fragment=null,this._state={}},get:function(){return this._state},fire:function(t,e){var r=t in this._handlers&&this._handlers[t].slice();if(r)for(var n=0;n<r.length;n+=1){var o=r[n];if(!o.__calling)try{o.__calling=!0,o.call(this,e)}finally{o.__calling=!1}}},on:function(t,e){var r=this._handlers[t]||(this._handlers[t]=[]);return r.push(e),{cancel:function(){var t=r.indexOf(e);~t&&r.splice(t,1)}}},set:function(t){this._set(m({},t)),this.root._lock||g(this.root)},_recompute:f,_set:function(t){var e=this._state,r={},n=!1;for(var o in t=m(this._staged,t),this._staged={},t)this._differs(t[o],e[o])&&(r[o]=n=!0);n&&(this._state=m(m({},e),t),this._recompute(r,this._state),this._bind&&this._bind(r,this._state),this._fragment&&(this.fire("state",{changed:r,current:this._state,previous:e}),this._fragment.p(r,this._state),this.fire("update",{changed:r,current:this._state,previous:e})))},_stage:function(t){m(this._staged,t)},_mount:function(t,e){this._fragment[this._fragment.i?"i":"m"](t,e||null)},_differs:function(t,e){return t!=t?e==e:t!==e||t&&"object"===h(t)||"function"==typeof t}},w=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,b=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;function C(t,e){if(null===t)return null;if(void 0!==t){if((t=String(t)).indexOf("<")<0||t.indexOf(">")<0)return t;if(t=function(t,e){e=(((void 0!==e?e||"":"<a><span><b><br><br/><i><strong><sup><sub><strike><u><em><tt>")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var r=t,n=t;for(;;)if(n=(r=n).replace(b,"").replace(w,(function(t,r){return e.indexOf("<"+r.toLowerCase()+">")>-1?t:""})),r===n)return n}(t,e),"undefined"==typeof document)return t;var r=document.createElement("div");r.innerHTML=t;for(var n=r.querySelectorAll("*"),o=0;o<n.length;o++){"a"===n[o].nodeName.toLowerCase()&&("_self"!==n[o].getAttribute("target")&&n[o].setAttribute("target","_blank"),n[o].setAttribute("rel","nofollow noopener noreferrer"),n[o].getAttribute("href")&&n[o].getAttribute("href").trim().startsWith("javascript:")&&n[o].setAttribute("href",""));for(var a=[],s=0;s<n[o].attributes.length;s++){var i=n[o].attributes[s];i.specified&&"on"===i.name.substr(0,2)&&a.push(i.name)}a.forEach((function(t){return n[o].removeAttribute(t)}))}return r.innerHTML}}function R(t,r,n,o){var a={date:"fa fa-clock-o"};return function(s,i,u,c,l,d,h){if(!(n.numColumns()<=c)&&n.hasColumn(c)){var f=n.column(c),m=t.get(),p=m.searchResults,v=m.currentResult,g=m.activeColumn,y=t.getColumnFormat(f.name());if((u=s.toPhysicalRow(u))>0){var _=e.columnFormatter(f,r.get().metadata,f.name());d=null===f.val(u-1)||""===f.val(u-1)?"–":_(f.val(u-1),!0)}parseInt(d)<0&&i.classList.add("negative"),i.classList.add(f.type()+"Type"),i.dataset.column=c,"text"===f.type()&&d&&d.length>70&&(d=d.substr(0,60)+"…"),0===u?(i.classList.add("firstRow"),a[f.type()]&&(d='<i class="'+a[f.type()]+'"></i> '+d)):i.classList.add(u%2?"oddRow":"evenRow"),y.ignore&&i.classList.add("ignored"),g&&g.name()===f.name()&&i.classList.add("active");var w=o.hooks.run(s,"modifyRow",u);p.forEach((function(t){t.row===w&&t.col===c&&i.classList.add("htSearchResult")})),v&&v.row===w&&v.col===c&&i.classList.add("htCurrentSearchResult"),u>0&&!f.type(!0).isValid(f.val(u-1))&&null!==f.val(u-1)&&""!==f.val(u-1)&&i.classList.add("parsingError"),u>0&&(null===f.val(u-1)||""===f.val(u-1))&&i.classList.add("noData"),f.isComputed&&f.errors.length&&f.errors.find((function(t){return"all"===t.row||t.row===u-1}))&&i.classList.add("parsingError"),h.readOnly&&i.classList.add("readOnly"),r.dataCellChanged(c,u)&&i.classList.add("changed"),function(t,e,r,n,a,s,i){var u=C(o.helper.stringify(s));e.innerHTML=u}(0,i,0,0,0,d)}}}function S(t){if(!t||"object"!==h(t))return t;try{return JSON.parse(JSON.stringify(t))}catch(e){return t}}var L=null,I=null;var x={render:function(){this.get().hot.render()},doSearch:function(){var t=this,e=this.get(),r=e.hot,n=e.search;clearTimeout(I),I=setTimeout((function(){if(r&&n){var e=r.getPlugin("search").query(n);t.set({searchResults:e})}else t.set({searchResults:[]})}),300)},update:function(){var e=this,r=this.get(),n=r.data,o=r.transpose,a=r.firstRowIsHeader,s=r.skipRows,i=r.hot;if(n){var u=this.store.get().dw_chart,c=u.dataset(dw.datasource.delimited({csv:n,transpose:o,firstRowIsHeader:a,skipRows:s}).parse()).dataset();this.set({columnOrder:c.columnOrder()});var l=[[]];c.eachColumn((function(t){return l[0].push(t.title())})),c.eachRow((function(t){var e=[];c.eachColumn((function(r){return e.push(r.raw(t))})),l.push(e)})),i.loadData(l);var d=R(this,u,c,t);i.updateSettings({cells:function(t,r){return{readOnly:e.get().readonly||c.hasColumn(r)&&c.column(r).isComputed&&0===t,renderer:d}},manualColumnMove:[]}),this.set({ds:c}),this.set({has_changes:S(chart.get("metadata.data.changes",[])).length>0}),t.hooks.once("afterRender",(function(){return e.initCustomEvents()})),t.hooks.once("afterRender",(function(){return e.fire("afterRender")})),i.render()}},dataChanged:function(t){var e=this,r=this.get().hot,n=!1;t.forEach((function(t){var o=d(t,4),a=o[0],s=o[1],i=o[2],u=o[3];if(i!==u){var c=e.store.get().dw_chart,l=e.get().transpose,h=S(c.get("metadata.data.changes",[]));if(a=r.toPhysicalRow(a),s=c.dataset().columnOrder()[s],l){var f=a;a=s,s=f}h.push({column:s,row:a,value:u,previous:i,time:(new Date).getTime()}),c.set("metadata.data.changes",h),n=!0}})),n&&setTimeout((function(){e.update(),chart.save()}),100)},columnMoved:function(e,r){var n=this,o=this.get().hot;if(e.length){var a=this.get().columnOrder,s=a.slice(0),u=a[r],c=s.splice(e[0],e.length),l=void 0===u?s.length:u?s.indexOf(u):0;s.splice.apply(s,[l,0].concat(i(c))),this.store.get().dw_chart.set("metadata.data.column-order",s.slice(0)),this.set({columnOrder:s}),t.hooks.once("afterRender",(function(){setTimeout((function(){n.fire("resetSort"),o.selectCell(0,l,o.countRows()-1,l+c.length-1)}),10)})),this.update()}},updateHeight:function(){var t=document.querySelector(".ht_master.handsontable .wtHolder .wtHider").getBoundingClientRect().height;this.refs.hot.style.height=Math.min(500,t+10)+"px"},checkRange:function(t,e,r,n){var o=this.get().hot,a=this.get().ds;if(e!==n||0!==t||r!==o.countRows()-1)if(e===n||0!==t||r!==o.countRows()-1)this.set({activeColumn:null,multiSelection:!1});else{for(var s=[],i=Math.min(e,n);i<=Math.max(e,n);i++)s.push(+document.querySelector("#data-preview .htCore tbody tr:first-child td:nth-child(".concat(i+2,")")).dataset.column);this.set({multiSelection:s.map((function(t){return a.column(t)})),activeColumn:null})}},initCustomEvents:function(){var t=this;setTimeout((function(){t.refs.hot.querySelectorAll(".htCore thead th:first-child").forEach((function(t){t.removeEventListener("click",T),t.addEventListener("click",T)})),t.refs.hot.querySelectorAll(".htCore thead th+th").forEach((function(t){t.removeEventListener("click",O),t.addEventListener("click",O)}))}),500)},getColumnFormat:function(t){return this.store.get().dw_chart.get("metadata.data.column-format",{})[t]||{type:"auto",ignore:!1}}};function k(){var e=this;L=this,t.hooks.once("afterRender",(function(){return e.initCustomEvents()})),window.addEventListener("keyup",(function(t){var r=e.get(),n=r.activeColumn,o=r.ds;if(n&&"input"!==t.target.tagName.toLowerCase()&&"textarea"!==t.target.tagName.toLowerCase()&&("ArrowRight"===t.key||"ArrowLeft"===t.key)){t.preventDefault(),t.stopPropagation();var a=o.indexOf(n.name());"ArrowRight"===t.key?e.set({activeColumn:o.column((a+1)%o.numColumns())}):e.set({activeColumn:o.column((a-1+o.numColumns())%o.numColumns())})}}));var r=this.store.get().dw_chart,n=new t(this.refs.hot,{data:[],rowHeaders:function(e){return t.hooks.run(n,"modifyRow",e)+1},colHeaders:!0,fixedRowsTop:1,fixedColumnsLeft:this.get().fixedColumnsLeft,filters:!0,startRows:13,startCols:8,fillHandle:!1,stretchH:"all",height:500,manualColumnMove:!0,selectionMode:"range",autoColumnSize:{useHeaders:!0,syncLimit:5},sortIndicator:!0,columnSorting:!0,sortFunction:function(t,e){if(e.col>-1){var n=r.dataset().column(e.col),o=n.type();return function(e,r){return 0===e[0]?-1:(e[1]=n.val(e[0]-1),r[1]=n.val(r[0]-1),"number"===o&&(isNaN(e[1])&&(e[1]=t?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY),isNaN(r[1])&&(r[1]=t?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY)),"date"===o&&("string"==typeof e[1]&&(e[1]=new Date(110,0,1)),"string"==typeof r[1]&&(r[1]=new Date(110,0,1))),("desc"===t?-1:1)*(e[1]>r[1]?1:e[1]<r[1]?-1:0))}}return function(t,e){return t[0]-e[0]}},afterGetColHeader:function(t,r){var n=e.get(),o=n.activeColumn,a=n.ds;a&&a.hasColumn(t)&&((0===t||t)&&o&&a.column(t).name()===o.name()&&r.classList.add("selected"),(0===t||t)&&(e.getColumnFormat(a.column(t).name()).ignore?r.classList.add("ignored"):r.classList.remove("ignored")))},search:"search"});window.HT=n,this.set({hot:n}),t.hooks.add("afterSetDataAtCell",(function(t){return e.dataChanged(t)})),t.hooks.add("afterColumnMove",(function(t,r){return e.columnMoved(t,r)})),t.hooks.add("afterRender",(function(){return e.updateHeight()})),t.hooks.add("afterSelection",(function(t,r,n,o){return e.checkRange(t,r,n,o)}))}function N(t){var e=t.changed,r=t.current,n=t.previous,o=r.hot;if(o){if(e.data&&this.update(),e.firstRowIsHeader&&n&&void 0!==n.firstRowIsHeader&&this.update(),e.hot&&this.update(),e.search&&n&&(this.doSearch(),this.set({searchIndex:0})),e.searchResults&&o.render(),e.currentResult&&r.currentResult){o.render();var a=r.currentResult;o.scrollViewportTo(a.row,a.col),setTimeout((function(){o.scrollViewportTo(a.row,a.col)}),100)}e.activeColumn&&setTimeout((function(){return o.render()}),10),e.fixedColumnsLeft&&o.updateSettings({fixedColumnsLeft:r.fixedColumnsLeft}),e.sorting&&o.getPlugin("columnSorting").sort(chart.dataset().indexOf(r.sorting.sortBy),r.sorting.sortDir?"asc":"desc")}}function O(t){for(var e=this.parentNode.children.length,r=-1,n=0;n<e;n++)if(this.parentNode.children.item(n)===this){r=n;break}var o=+L.refs.hot.querySelector(".htCore tbody tr:first-child td:nth-child(".concat(r+1,")")).dataset.column,a=L.store.get().dw_chart,s=L.get(),i=s.activeColumn,u=s.hot;if(a.dataset().hasColumn(o)){var c=a.dataset().column(+o);i&&i.name()===c.name()?(t.target.parentNode.classList.remove("selected"),L.set({activeColumn:!1}),u.deselectCell()):(t.target.parentNode.classList.add("selected"),L.set({activeColumn:c}))}}function T(t){t.preventDefault();var e=L.get().transpose;L.set({transpose:!e}),L.update()}function E(t,e){var r;return{c:function(){var t;t="div",(r=document.createElement(t)).id="data-preview"},m:function(e,n){!function(t,e,r){t.insertBefore(e,r)}(e,r,n),t.refs.hot=r},p:f,d:function(e){var n;e&&(n=r).parentNode.removeChild(n),t.refs.hot===r&&(t.refs.hot=null)}}}function A(t){var e=this;!function(t,e){t._handlers=v(),t._slots=v(),t._bind=e._bind,t._staged={},t.options=e,t.root=e.root||t,t.store=e.store||t.root.store,e.root||(t._beforecreate=[],t._oncreate=[],t._aftercreate=[])}(this,t),this.refs={},this._state=m({hot:null,data:"",readonly:!1,skipRows:0,firstRowIsHeader:!0,fixedColumnsLeft:0,searchIndex:0,sortBy:"-",transpose:!1,activeColumn:null,search:"",searchResults:[]},t.data),this._recompute({searchResults:1,searchIndex:1},this._state),this._intro=!0,this._handlers.state=[N],N.call(this,{changed:p({},this._state),current:this._state}),this._fragment=E(this,this._state),this.root._oncreate.push((function(){k.call(e),e.fire("update",{changed:p({},e._state),current:e._state})})),t.target&&(this._fragment.c(),this._mount(t.target,t.anchor),g(this))}return m(A.prototype,_),m(A.prototype,x),A.prototype._recompute=function(t,e){(t.searchResults||t.searchIndex)&&this._differs(e.currentResult,e.currentResult=function(t){var e=t.searchResults,r=t.searchIndex;if(!e||!e.length)return null;var n=e.length;if(r<0||r>=n){for(;r<0;)r+=n;r>n&&(r%=n)}return e[r]}(e))&&(t.currentResult=!0)},{Handsontable:A}}));
